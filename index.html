<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ニュース検索 RAG＋確認テスト</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111; --muted:#666; --border:#e9e9e9; --accent:#2563eb;
    --shadow:0 6px 24px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background:var(--bg); color:var(--fg);
  }
  header{
    position:sticky; top:0; z-index:10; background:rgba(255,255,255,.9); backdrop-filter: blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  h1{font-size:20px; margin:0; font-weight:700; letter-spacing:.2px}
  .badge{font-size:12px; color:#fff; background:var(--accent); border-radius:999px; padding:4px 10px}
  .card{
    background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; animation:fadeIn .5s ease both; 
  }
  .grid{display:grid; gap:16px}
  @media(min-width:900px){ .grid-2{grid-template-columns: 1.2fr .8fr} }
  .muted{color:var(--muted)}
  input[type="text"]{
    width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; outline:none; font-size:16px;
  }
  input[type="file"]{font-size:14px}
  button{
    appearance:none; border:none; background:var(--accent); color:#fff; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
    transition:transform .05s ease, opacity .2s ease; box-shadow:var(--shadow);
  }
  button.ghost{background:#f2f6ff; color:#1e40af}
  button.secondary{background:#111; color:#fff}
  button:active{transform: translateY(1px)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .result-list{display:grid; gap:10px}
  .result-btn{
    text-align:left; background:#fff; color:inherit; border:1px solid var(--border); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow);
    display:flex; flex-direction:column; gap:6px;
  }
  .title{font-weight:700; line-height:1.35; font-size:16px}
  .meta{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .series-tag{
    background:#6b7280; color:#fff; font-size:11px; padding:3px 10px; border-radius:999px; font-weight:500;
  }
  .score{margin-left:auto; font-variant-numeric: tabular-nums; font-size:12px; color:#0b5}
  .quiz-row{display:flex; gap:8px; flex-wrap:wrap}
  .quiz-btn{
    background:#fafafa; color:#111; border:1px solid var(--border); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow);
    max-width:100%; text-align:left;
  }
  .small{font-size:12px}
  .hint{font-size:13px; color:var(--muted)}
  .section-title{font-weight:700; margin:0 0 8px 0}
  .spacer{height:6px}
  .footer{padding:24px 0; color:var(--muted); font-size:12px; text-align:center}
  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:20;
  }
  .modal{
    max-width:900px; width:100%; max-height:90vh; background:#fff; border-radius:18px; box-shadow:var(--shadow); border:1px solid var(--border);
    animation:pop .18s ease both; display:flex; flex-direction:column;
  }
  .modal header{position:sticky; top:0; background:#fff; padding:16px; border-bottom:1px solid var(--border); border-top-left-radius:18px; border-top-right-radius:18px; flex-shrink:0}
  .modal .content{padding:16px; display:grid; gap:12px; overflow-y:auto; flex:1}
  .modal .title{font-size:20px}
  .rel-list{display:grid; gap:8px}
  .x{background:#f5f5f5; color:#333}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#f6f7fb; border:1px solid var(--border); font-size:12px}
  @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  @keyframes pop{from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)}}
  /* Entities Viz */
  .charts{display:grid; gap:12px}
  @media(min-width:900px){ .charts{grid-template-columns: 1fr 1fr} }
  #entitiesCard canvas{width:100%; height:320px}
  /* Extra viz section */
  #entitiesPlusCard canvas{width:100%; height:320px}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<!-- Chart.js 本体（UMD版） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

<!-- chartjs-chart-wordcloud（UMD版） -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud@4.4.4/build/index.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3.1.0/dist/chartjs-chart-treemap.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="row" style="gap:10px; align-items:center">
        <h1>ニュース検索 RAG＋確認テスト</h1>
        <span class="badge">beta</span>
      </div>
      <div class="toolbar" style="margin-left:auto">
        <span id="apiStatus" class="chip">APIキー: 未設定</span>
        <button class="ghost" id="changeKeyBtn" title="APIキーを再設定">APIキー変更</button>
      </div>
    </div>
  </header>

  <main class="wrap grid grid-2" style="margin-top:16px">
    <section class="card" id="inputCard">
      <h2 class="section-title">検索とデータ</h2>
      <div class="row">
        <div style="flex:1; min-width:220px">
          <input id="queryInput" type="text" placeholder="検索したい言葉（例: EV 電池 供給網）" />
          <div class="hint">検索語を <strong>Gemini Embeddings</strong> に送り、アップロード済みJSONL（ベクトルDB）と照合します。</div>
        </div>
        <div class="row" style="gap:8px">
          <input id="fileInput" type="file" accept=".jsonl,application/jsonl,text/plain" />
          <button id="searchBtn">検索</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="row small">
        <span id="fileMeta" class="muted">JSONL未読込</span>
        <span id="stats" class="muted" style="margin-left:auto"></span>
      </div>
    </section>

    <aside class="card" id="quizCard">
      <h2 class="section-title">クイック確認テスト</h2>
      <div class="hint">上位7件の記事からランダムに5問をピックアップ。ボタンを押すと該当記事の詳細へ。</div>
      <div class="spacer"></div>
      <div id="quizButtons" class="quiz-row"></div>
    </aside>

    <section class="card" style="grid-column: 1 / -1">
      <h2 class="section-title">検索結果（上位7件）</h2>
      <div id="results" class="result-list"></div>
    </section>

    <section class="card" id="entitiesCard" style="grid-column: 1 / -1">
      <h2 class="section-title">エンティティ可視化（上位20）</h2>
      <div class="hint">JSONL内の <code>entities</code> または <code>named_entities</code> を集計して可視化します（ファイル読込時に自動集計）。</div>
      <div class="spacer"></div>
      <div class="charts">
        <div>
          <div class="small muted" style="margin-bottom:6px">Word Cloud</div>
          <canvas id="wcCanvas"></canvas>
        </div>
        <div>
          <div class="small muted" style="margin-bottom:6px">Polar Area</div>
          <canvas id="polarCanvas"></canvas>
        </div>
      </div>
    </section>
    <section class="card" id="entitiesPlusCard" style="grid-column: 1 / -1">
      <h2 class="section-title">その他のエンティティ可視化</h2>
      <div class="hint">Treemap と Bubble で上位エンティティの分布を表示します。</div>
      <div class="spacer"></div>
      <div class="charts">
        <div>
          <div class="small muted" style="margin-bottom:6px">Treemap</div>
          <canvas id="treemapCanvas"></canvas>
        </div>
        <div>
          <div class="small muted" style="margin-bottom:6px">Doughnut</div>
          <canvas id="doughnutCanvas"></canvas>
        </div>
      </div>
    </section>
  </main>
 

  <div class="footer">© 2025 News RAG+Quiz — client-side demo</div>

  <!-- Modal -->
  <div id="modalRoot" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row">
        <div style="flex:1">
          <div id="mTitle" class="title"></div>
          <div class="meta">
            <span id="mDate"></span>
            <span id="mSeries" class="muted"></span>
          </div>
        </div>
        <div class="toolbar">
          <button class="x" id="closeModalBtn">閉じる</button>
        </div>
      </header>
      <div class="content">
        <div id="mSub" class="muted"></div>
        <div id="mBody" style="white-space:pre-wrap; line-height:1.7"></div>
        <div class="row" style="justify-content:center">
          <button id="checkBtn" class="" style="min-width:200px">理解度を確認する</button>
          <button id="answerBtn" class="secondary" style="display:none; min-width:200px">解答を確認する</button>
        </div>
        <div id="qaBlock" style="display:none">
          <div id="qaList" class="grid"></div>
        </div>
        <div>
          <h3 class="section-title">関連するニュース</h3>
          <div id="relList" class="rel-list"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------------- State ----------------
  let API_KEY = null;
  let DATA = [];           // parsed items
  let EMBED_DIM = null;    // detected dimension
  let lastQueryVec = null; // Float32Array
  let topSeven = [];       // last search results (array of items with score)
  let ENTITY_TOP = [];   // [ [label, count], ... ] top-N
  let entityCharts = { wc:null, polar:null, treemap:null, bubble:null };

  // ------------- Helpers -------------
  const $ = sel => document.querySelector(sel);
  const $el = (tag, attrs={}, ...children) => {
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v]) => {
      if (k === 'class') n.className = v;
      else if (k === 'style') n.setAttribute('style', v);
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    });
    children.forEach(c => n.append(c));
    return n;
  };

const fmtDate = v => {
    if (!v) return '';
    try{
        // Handle ISO8601 format like "20250626T123128+0900"
        let dateStr = String(v);
        if (/^\d{8}T\d{6}[+-]\d{4}$/.test(dateStr)) {
            // Convert "20250626T123128+0900" to "2025-06-26T12:31:28+09:00"
            dateStr = dateStr.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})([+-]\d{2})(\d{2})$/, 
                '$1-$2-$3T$4:$5:$6$7:$8');
        }
        
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return String(v);
        
        // Format as Japanese date and time
        const y = d.getFullYear();
        const m = ('0' + (d.getMonth() + 1)).slice(-2);
        const dd = ('0' + d.getDate()).slice(-2);
        const h = ('0' + d.getHours()).slice(-2);
        const min = ('0' + d.getMinutes()).slice(-2);
        
        return `${y}-${m}-${dd} ${h}:${min}`;
    }catch{ 
        return String(v);
    }
};

  const cosineSim = (a, b) => {
    if (!a || !b) return 0;
    let dot=0, na=0, nb=0;
    const L = Math.min(a.length, b.length);
    for (let i=0;i<L;i++){ const x=a[i], y=b[i]; dot+=x*y; na+=x*x; nb+=y*y; }
    if (na===0 || nb===0) return 0;
    return dot / (Math.sqrt(na)*Math.sqrt(nb));
  };

  const avgVec = (v1, v2) => {
    if (v1 && v2) {
      const L = Math.min(v1.length, v2.length);
      const out = new Float32Array(L);
      for (let i=0;i<L;i++) out[i] = 0.5*(v1[i]+v2[i]);
      return out;
    } else return (v1 || v2) ? new Float32Array(v1 || v2) : null;
  };

  const pickVector = (obj, prefixCandidates) => {
    // Look for keys like headline_embedding, headline_embed, headline_vector, headline_vec
    const keys = Object.keys(obj);
    let best = null;
    for (const pref of prefixCandidates) {
      for (const k of keys) {
        const lower = k.toLowerCase();
        if (!lower.startsWith(pref)) continue;
        const val = obj[k];
        if (Array.isArray(val) && val.length>8 && typeof val[0] === 'number') {
          best = val; break;
        }
        // nested {values:[...]} pattern
        if (val && typeof val === 'object' && Array.isArray(val.values)) {
          if (val.values.length>8 && typeof val.values[0]==='number') { best = val.values; break; }
        }
      }
      if (best) break;
    }
    // Fallback: first large numeric array in the object
    if (!best) {
      for (const k of keys) {
        const val = obj[k];
        if (Array.isArray(val) && val.length>8 && typeof val[0] === 'number') { best = val; break; }
      }
    }
    return best ? new Float32Array(best) : null;
  };

  const getText = (obj, keys) => {
    for (const k of keys) if (obj[k] != null) return String(obj[k]);
    return '';
  };

  const getList = (obj, keys) => {
    for (const k of keys) if (Array.isArray(obj[k])) return obj[k];
    return null;
  };

  // ------------- Entities (collect & viz) -------------
  const collectEntitiesMap = (items) => {
    const map = new Map();
    for (const it of items) {
      // prefer explicit list on the raw item
      let ents = getList(it.raw, ['entities','named_entities','Entities','Keywords','keywords']);
      if (!ents && Array.isArray(it.entities)) ents = it.entities;
      if (!ents) continue;
      for (let e of ents) {
        if (e == null) continue;
        let s = String(e).trim();
        if (!s) continue;
        // ignore pure numbers or 1-char ASCII noise
        if (/^\d+$/.test(s)) continue;
        if (/^[ -~]$/.test(s)) continue;
        map.set(s, (map.get(s) || 0) + 1);
      }
    }
    return map;
  };

  const topNFromMap = (map, n=20) =>
    Array.from(map.entries()).sort((a,b)=> b[1]-a[1]).slice(0,n);

  const renderWordCloud = (topPairs) => {
    const el = document.getElementById('wcCanvas');
    if (!el) return;
    if (entityCharts.wc) { entityCharts.wc.destroy(); entityCharts.wc = null; }
    const labels = topPairs.map(([w])=> w);
    const data = topPairs.map(([_,c])=> c);
    console.log('Render WordCloud', labels, data);
    // (20) ['トカラ列島', '気象庁', '鹿児島', '悪石島', '小宝島', 'ドル', 'ユーロ', '円', 'イラン', '東京', 'トランプ', '津波', 'マグニチュード', '日本', '米国', 'イスラエル', '広島', '鹿児島県', 'ＴＯＰＩＸ', '十島村']0: "トカラ列島"1: "気象庁"2: "鹿児島"3: "悪石島"4: "小宝島"5: "ドル"6: "ユーロ"7: "円"8: "イラン"9: "東京"10: "トランプ"11: "津波"12: "マグニチュード"13: "日本"14: "米国"15: "イスラエル"16: "広島"17: "鹿児島県"18: "ＴＯＰＩＸ"19: "十島村"length: 20[[Prototype]]: Array(0) (20) [526, 518, 491, 407, 142, 138, 133, 132, 122, 122, 97, 91, 83, 77, 71, 66, 58, 58, 58, 55]
    try{
      entityCharts.wc = new Chart(el.getContext('2d'), {
        type: 'wordCloud',
        data: { labels, datasets: [{
          data: data.map(d => Math.round((Math.log10(d)+1)*10))
          }]
         },
        options: {
          // responsive: true,
          responsive: false,
          fit: true,
          color: (ctx) => {
            if (ctx.dataIndex === 0) return '#9b59b6'; // 紫色
            if (ctx.dataIndex < 5) return '#6b4f4f'; // こげ茶色
            return undefined; // その他
          },
          fontWeight: ctx => (ctx.dataIndex === 0 ? 'extraBold' : (ctx.dataIndex < 5 ? 'bold' : 'normal')),
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: { label: ctx => `${ctx.label}: ${data[ctx.dataIndex]}件` }
            }
          },
          elements: { word: { padding: 2, rotate: 0 } }
        }
      });
    }catch(e){
      // If plugin failed to load, write a friendly message into the canvas's parent
      const parent = el.parentElement;
      const note = document.createElement('div');
      note.className = 'small muted';
      note.textContent = 'WordCloudプラグインの読み込みに失敗したため、下のPolar Areaのみ表示しています。';
      parent.appendChild(note);
    }
  };

  const renderPolar = (topPairs) => {
    const el = document.getElementById('polarCanvas');
    if (!el) return;
    if (entityCharts.polar) { entityCharts.polar.destroy(); entityCharts.polar = null; }
    const labels = topPairs.map(([w])=> w);
    const data = topPairs.map(([_,c])=> c);
    entityCharts.polar = new Chart(el.getContext('2d'), {
      type: 'polarArea',
      data: { labels, datasets: [{ data }] },
      options: {
        responsive: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}件` } }
        },
        scales: { r: { ticks: { precision:0 } } }
      }
    });
  };

  const renderTreemap = (topPairs) => {
    const el = document.getElementById('treemapCanvas');
    if (!el) return;
    if (entityCharts.treemap) { entityCharts.treemap.destroy(); entityCharts.treemap = null; }
    const tree = topPairs.map(([label, value]) => ({ label, value }));
    
    // 値の最大と最小を取得して色の濃淡を計算するために使用
    const values = topPairs.map(([,c]) => c);
    const maxVal = values.length > 0 ? Math.max(...values) : 0;
    const minVal = values.length > 0 ? Math.min(...values) : 0;
    const range = maxVal - minVal;

    console.log('Render Treemap', tree);
    /* [ { "label": "トカラ列島", "value": 526 }, ... ] */
    try{
      entityCharts.treemap = new Chart(el.getContext('2d'), {
        type: 'treemap',
        data: {
          datasets: [{
            tree,
            key: 'value',
            groups: ['label'],
            spacing: 1,
            borderWidth: 1,
            borderColor: 'rgba(255,255,255,0.5)',
            // 値に応じて背景色を動的に設定
            backgroundColor: (ctx) => {
              if (!ctx.raw) return '#ccc';
              const value = ctx.raw.v;
              // 値を0-1の範囲に正規化
              const ratio = range > 0 ? (value - minVal) / range : 0;
              // 明度を 75% (薄い) から 30% (濃い) の間で変化させる
              const lightness = 75 - (ratio * 45);
              return `hsl(220, 80%, ${lightness}%)`;
            },
            labels: {
              display: true,
              formatter: ctx => ctx.raw ? `${ctx.raw._data.label}` : '',
              color: '#fff',
              font: { size: 12, weight: '600' },
              position: 'center',
            },
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: { 
                label: c => c.raw ? `${c.raw._data.label}: ${c.raw.v}件` : ''
              }
            }
          }
        }
      });
    }catch(e){
      const parent = el.parentElement;
      const note = document.createElement('div');
      note.className = 'small muted';
      note.textContent = 'Treemapプラグインの読み込みに失敗しました。';
      parent.appendChild(note);
    }
  };

  const renderDoughnut = (topPairs) => {
    const el = document.getElementById('doughnutCanvas');
    if (!el) return;
    if (entityCharts.doughnut) { entityCharts.doughnut.destroy(); entityCharts.doughnut = null; }
    const labels = topPairs.map(([w])=> w);
    const data = topPairs.map(([_,c])=> c);

    // 値の最大と最小を取得して色の濃淡を計算するために使用
    const maxVal = data.length > 0 ? Math.max(...data) : 0;
    const minVal = data.length > 0 ? Math.min(...data) : 0;
    const range = maxVal - minVal;

    entityCharts.doughnut = new Chart(el.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels, 
        datasets: [
          {
            data: data,
            backgroundColor: (ctx) => {
              if (ctx.raw == null) return '#ccc';
              const value = ctx.raw;
              // 値を0-1の範囲に正規化
              const ratio = range > 0 ? (value - minVal) / range : 0;
              // 明度を 75% (薄い) から 30% (濃い) の間で変化させる
              const lightness = 75 - (ratio * 45);
              return `hsl(220, 80%, ${lightness}%)`;
            }
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}件` } }
        }
      }
    });
  };

  const updateEntitiesViz = (items) => {
    const map = collectEntitiesMap(items);
    ENTITY_TOP = topNFromMap(map, 50); // collect top 50 for better distribution
    renderWordCloud(ENTITY_TOP.slice(0,30)); // word cloud shows top 30
    renderPolar(ENTITY_TOP.slice(0,20)); // polar area shows top 20
    renderTreemap(ENTITY_TOP.slice(0,10)); // treemap shows top 10
    renderDoughnut(ENTITY_TOP); // doughnut shows top 50
  };

  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1; i>0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  };

  // ------------- API Key -------------
  const updateKeyStatus = () => {
    $('#apiStatus').textContent = 'APIキー: ' + (API_KEY ? '設定済' : '未設定');
  };
  const ensureApiKey = async () => {
    API_KEY = localStorage.getItem('GEMINI_API_KEY') || null;
    if (!API_KEY) {
      const k = prompt('GEMINI_API_KEY を入力してください（保存されます）');
      if (k && k.trim()) {
        API_KEY = k.trim();
        localStorage.setItem('GEMINI_API_KEY', API_KEY);
      }
    }
    updateKeyStatus();
  };

  // ------------- Embedding (Gemini) -------------
  const embedQuery = async (text) => {
    if (!API_KEY) throw new Error('APIキー未設定');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent?key=${encodeURIComponent(API_KEY)}`;
    const payload = {
      model: "models/gemini-embedding-001",
      content: { parts: [{ text }] }
    };
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      throw new Error(`Embedding API error: ${res.status} ${t}`);
    }
    const js = await res.json();
    // single input -> js.embedding.values ; batch -> js.embeddings[0].values
    const vec = js?.embedding?.values || js?.embeddings?.[0]?.values;
    if (!Array.isArray(vec)) throw new Error('Embeddingレスポンス形式不明');
    return new Float32Array(vec);
  };

  // ------------- JSONL Parsing -------------
  const parseJSONL = async (file) => {
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    const items = [];
    for (let i=0;i<lines.length;i++){
      const L = lines[i];
      try{
        const o = JSON.parse(L);
        // Extract main fields
        const headline = getText(o, ['headline','title','Headline']);
        const sub = getText(o, ['subheadline','sub_headline','Subheadline','subtitle']);
        const content = getText(o, ['content','body','article','text','Content']);
        const date = getText(o, ['date','published_at','date_time','time','Date']);
        const series = getText(o, ['seriesline','series_line','series','category','source']);
        // QA detection: "questions": [{question, answer}, ...] OR "qa": [...]
        let qlist = getList(o, ['questions','qa','quiz','QAs']);
        if (!qlist && o.question && o.answer) {
          qlist = [{question: String(o.question), answer: String(o.answer)}];
        }
        if (Array.isArray(qlist)) {
          qlist = qlist.map(q => {
            if (typeof q === 'string') return {question:q, answer:''};
            const qs = getText(q, ['question','q','問','Question']);
            const an = getText(q, ['answer','a','解答','Answer']);
            return {question:qs, answer:an};
          }).filter(x => x.question);
        } else {
          qlist = [];
        }
        // Embeddings (robust key search)
        const hv = pickVector(o, ['headline_embedding','headline_embed','headline_vector','headline_vec','headline']);
        const cv = pickVector(o, ['content_embedding','content_embed','content_vector','content_vec','content','body']);
        // Entities (optional)
        const ents = getList(o, ['entities','named_entities','Entities','Keywords','keywords']) || [];
        // Track dimension
        if (!EMBED_DIM) EMBED_DIM = hv?.length || cv?.length || EMBED_DIM;
        items.push({
          raw:o, headline, subheadline:sub, content, date, seriesline:series,
          hv, cv, qa: qlist, entities: ents
        });
      }catch(e){
        console.warn('JSONL parse error at line', i+1, e);
      }
    }
    return items;
  };

  // ------------- Ranking -------------
  const rankByQuery = (qvec, items) => {
    const scored = [];
    for (let i=0;i<items.length;i++){
      const it = items[i];
      const sH = it.hv ? cosineSim(qvec, it.hv) : 0;
      const sC = it.cv ? cosineSim(qvec, it.cv) : 0;
      const s = (sH + sC) / ( (it.hv?1:0) + (it.cv?1:0) || 1 );
      scored.push({idx:i, score:s, sH, sC});
    }
    scored.sort((a,b)=> b.score - a.score);
    return scored;
  };

  const relatedByMaxPair = (base, items, limit=5) => {
    const out = [];
    const H = base.hv, C = base.cv;
    for (let i=0;i<items.length;i++){
      const it = items[i];
      if (it===base) continue;
      // max over 4 pairwise sims
      const cands = [];
      if (H && it.hv) cands.push(cosineSim(H, it.hv));
      if (H && it.cv) cands.push(cosineSim(H, it.cv));
      if (C && it.hv) cands.push(cosineSim(C, it.hv));
      if (C && it.cv) cands.push(cosineSim(C, it.cv));
      const s = cands.length ? Math.max(...cands) : 0;
      out.push({it, score:s});
    }
    out.sort((a,b)=> b.score - a.score);
    return out.slice(0,limit);
  };

  // ------------- UI Render -------------
  const renderResults = (scoredTop) => {
    const list = $('#results'); list.innerHTML = '';
    for (const r of scoredTop) {
      const it = DATA[r.idx];
      const btn = $el('button', {class:'result-btn', onclick:()=> openModalByIndex(r.idx)});
      const title = $el('div', {class:'title', style:'font-size:18px'}, it.headline || '(無題)');
      const meta = $el('div', {class:'meta'});
      
      // Add date
      const dateSpan = $el('span', {style:'color:#666; font-weight:500'}, fmtDate(it.date) || '—');
      meta.append(dateSpan);
      
      // Add series tag if exists
      if (it.seriesline && it.seriesline.trim()) {
        const seriesTag = $el('span', {class:'series-tag'}, it.seriesline);
        meta.append(seriesTag);
      }
      
      // Add score
      const scoreSpan = $el('span', {class:'score'}, `score ${r.score.toFixed(3)}`);
      meta.append(scoreSpan);


      
      btn.append(title, meta);
      list.append(btn);
    }
  };

  const sampleQuizFromTop = (scoredTop) => {
    const pool = [];
    for (const r of scoredTop) {
      const it = DATA[r.idx];
      (it.qa||[]).forEach((qa, qidx) => {
        pool.push({idx:r.idx, qidx, q: qa.question});
      });
    }
    const picked = shuffle(pool).slice(0,5);
    const wrap = $('#quizButtons'); wrap.innerHTML = '';
    if (!picked.length) {
      wrap.append($el('div', {class:'muted'}, 'この検索結果にクイズが見つかりませんでした'));
      return;
    }
    for (const p of picked) {
      const t = p.q.length>80 ? p.q.slice(0,77)+'…' : p.q;
      const b = $el('button', {class:'quiz-btn', title:p.q, onclick:()=> openModalByIndex(p.idx)}, 'Q: ', t);
      wrap.append(b);
    }
  };

  const openModalByIndex = (idx) => {
    const it = DATA[idx];
    $('#mTitle').textContent = it.headline || '(無題)';
    $('#mDate').textContent = fmtDate(it.date) || '';
    $('#mSeries').textContent = it.seriesline || '';
    $('#mSub').textContent = it.subheadline || '';
    $('#mBody').textContent = it.content || '';
    // Reset modal state to show article content by default
    $('#mBody').style.display = '';
    $('#mDate').style.display = '';
    $('#qaBlock').style.display = 'none';
    $('#answerBtn').style.display = 'none';
    $('#checkBtn').style.display = '';
    // Build QA list (2~3問程度を表示: 仕様上は既存数に従う)
    const qaWrap = $('#qaList'); qaWrap.innerHTML = '';
    const qaShow = (it.qa||[]).slice(0, Math.min(3, (it.qa||[]).length));
    qaShow.forEach((qa, i) => {
      const card = $el('div', {class:'card'});
      const q = $el('div', {style:'font-weight:700; margin-bottom:6px'}, `Q${i+1}. `, qa.question || '');
      const a = $el('div', {class:'muted', style:'white-space:pre-wrap; display:none'}, qa.answer || '');
      card.append(q, a);
      qaWrap.append(card);
    });
    // Related
    const rel = relatedByMaxPair(it, DATA, 5);
    const relWrap = $('#relList'); relWrap.innerHTML = '';
    for (const r of rel) {
      const b = $el('button', {class:'result-btn', onclick:()=> openModalByIndex(DATA.indexOf(r.it))});
      b.append(
        $el('div', {class:'title'}, r.it.headline || '(無題)'),
        $el('div', {class:'meta'},
          $el('span', {}, fmtDate(r.it.date) || '—'),
          $el('span', {class:'muted'}, r.it.seriesline || ''),
          $el('span', {class:'score'}, `rel ${r.score.toFixed(3)}`),
        )
      );
      relWrap.append(b);
    }
    // Attach behavior
    $('#checkBtn').onclick = () => {
      // Hide article body+date, show questions + "解答を確認する"
      $('#mBody').style.display = 'none';
      $('#mDate').style.display = 'none';
      $('#qaBlock').style.display = '';
      $('#answerBtn').style.display = '';
      $('#checkBtn').style.display = 'none';
    };
    $('#answerBtn').onclick = () => {
      // Show article & answers
      $('#mBody').style.display = '';
      $('#mDate').style.display = '';
      // reveal answers
      Array.from($('#qaList').querySelectorAll('.muted')).forEach(el => el.style.display='');
      $('#answerBtn').style.display = 'none';
    };

    $('#modalRoot').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  };

  const closeModal = () => {
    $('#modalRoot').style.display = 'none';
    document.body.style.overflow = '';
  };

  // ------------- Events -------------
  $('#closeModalBtn').addEventListener('click', closeModal);
  $('#modalRoot').addEventListener('click', (e)=>{
    if (e.target === $('#modalRoot')) closeModal();
  });

  $('#changeKeyBtn').addEventListener('click', ()=>{
    const k = prompt('新しい GEMINI_API_KEY を入力してください', API_KEY||'');
    if (k && k.trim()) {
      API_KEY = k.trim();
      localStorage.setItem('GEMINI_API_KEY', API_KEY);
      updateKeyStatus();
    }
  });

  $('#fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    $('#fileMeta').textContent = '読み込み中…';
    DATA = await parseJSONL(f);
    updateEntitiesViz(DATA);
    const uniqueEnts = new Set(DATA.flatMap(d => Array.isArray(d.entities) ? d.entities : [])).size;
    $('#fileMeta').textContent = `${f.name} | ${DATA.length}件 読込 | 次元: ${EMBED_DIM||'?'} | エンティティ: ${uniqueEnts}種`;
  });

  const doSearch = async () => {
    try{
      const q = $('#queryInput').value.trim();
      if (!q) { alert('検索語を入力してください'); return; }
      if (!DATA.length) { alert('先にJSONLファイルをアップロードしてください'); return; }
      $('#stats').textContent = '埋め込み計算中…';
      await ensureApiKey();
      if (!API_KEY) { alert('APIキーが必要です'); return; }

      lastQueryVec = await embedQuery(q);
      $('#stats').textContent = '類似度計算中…';

      const ranked = rankByQuery(lastQueryVec, DATA);
      topSeven = ranked.slice(0,7);
      renderResults(topSeven);
      sampleQuizFromTop(topSeven);
      $('#stats').textContent = `完了: ${DATA.length}件から上位7件を表示`;
    }catch(err){
      console.error(err);
      alert(err.message || '検索でエラーが発生しました');
      $('#stats').textContent = 'エラー';
    }
  };

  $('#searchBtn').addEventListener('click', doSearch);
  $('#queryInput').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doSearch(); });

  // ------------- Init -------------
  (async()=>{ await ensureApiKey(); })();
})();
</script>
</body>
</html>