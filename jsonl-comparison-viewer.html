<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSONL Question Set Comparator</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 2rem;
      background: #f5f5f7;
      color: #172033;
    }

    .container {
      /* max-width: 1100px; */
      margin: 0 auto;
      background: #ffffff;
      border-radius: 14px;
      padding: 2rem;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12);
    }

    h1 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }

    p.description {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #4b5563;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    label[for="fileInput"] {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.85rem 1.5rem;
      border-radius: 9999px;
      background: #1d4ed8;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    label[for="fileInput"]:hover {
      background: #1e40af;
      transform: translateY(-1px);
    }

    input[type="file"] {
      display: none;
    }

    .notice {
      margin: 1rem 0 1.5rem;
      padding: 0.9rem 1.2rem;
      border-radius: 10px;
      background: #e0f2fe;
      color: #075985;
      font-size: 0.95rem;
    }

    .summary-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .summary-card {
      padding: 1rem 1.25rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      display: grid;
      gap: 0.35rem;
    }

    .summary-card strong {
      font-size: 1rem;
      color: #111827;
    }

    .error-box {
      margin-top: 1.5rem;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      background: #fef3c7;
      color: #92400e;
      white-space: pre-line;
    }

    .articles {
      margin-top: 2.5rem;
      display: grid;
      gap: 2rem;
    }

    .article {
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 1.75rem;
      background: #f9fafb;
    }

    .article header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .article h2 {
      margin: 0;
      font-size: 1.35rem;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .content {
      margin: 1rem 0;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .comparison-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    @media (min-width: 768px) {
      .comparison-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    .file-card {
      position: relative;
      padding: 1.2rem;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: inset 0 0 0 4px rgba(255, 255, 255, 0.7);
      min-height: 160px;
      display: grid;
      gap: 0.6rem;
    }

    .file-card::before {
      content: attr(data-filename);
      font-weight: 600;
      font-size: 0.95rem;
      color: inherit;
    }

    .file-card[data-status="missing"] {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .question-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 0.85rem;
    }

    .question-item {
      display: grid;
      gap: 0.4rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid #f3f4f6;
    }

    .question-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .choices {
      margin: 0;
      padding-left: 1.2rem;
      color: #1f2937;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.2rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(79, 70, 229, 0.12);
      color: #3730a3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>JSONL Question Set Comparator</h1>
    <p class="description">
      同一ニュース記事（<code>news_item_id</code> などの一意なID）を持つ複数のJSONLファイルを読み込み、理解度テストの問題構成の違いを比較するビューです。
      最大4ファイルまで同時に選択できます。
    </p>

    <label for="fileInput">
      JSONLファイルを複数選択
      <input id="fileInput" type="file" accept=".jsonl,.json" multiple>
    </label>

    <div id="notice" class="notice" hidden></div>
    <section id="summary" class="summary-grid"></section>
    <section id="errors" hidden></section>
    <section id="articles" class="articles" aria-live="polite"></section>
  </div>

  <script>
    const MAX_FILES = 4;
    const fileInput = document.getElementById('fileInput');
    const noticeEl = document.getElementById('notice');
    const summaryEl = document.getElementById('summary');
    const errorsEl = document.getElementById('errors');
    const articlesEl = document.getElementById('articles');

    fileInput.addEventListener('change', handleSelection);

    function handleSelection(event) {
      const files = Array.from(event.target.files);
      clearDisplay();

      if (!files.length) {
        return;
      }

      if (files.length === 1) {
        showNotice('比較には2つ以上のファイルを選択してください。');
        return;
      }

      if (files.length > MAX_FILES) {
        showNotice(`最大${MAX_FILES}ファイルまで選択できます。先頭${MAX_FILES}件のみを処理します。`);
      }

      const selectedFiles = files.slice(0, MAX_FILES);
      showNotice(`読み込み中: ${selectedFiles.map((file) => file.name).join(', ')}`);

      Promise.all(selectedFiles.map(readFile))
        .then((fileContents) => processFiles(selectedFiles, fileContents))
        .catch((error) => {
          showNotice(`読み込み中にエラーが発生しました: ${error.message}`);
        });
    }

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file, 'utf-8');
      });
    }

    function processFiles(files, contents) {
      const processed = files.map((file, index) => parseJSONL(file, contents[index]));
      renderSummary(processed);
      renderErrors(processed);
      renderArticles(processed);
      showNotice(`読み込み完了: ${files.map((file) => file.name).join(', ')}`);
    }

    function parseJSONL(file, rawText) {
      const lines = rawText.split(/\r?\n/).filter((line) => line.trim().length > 0);
      const dataById = new Map();
      const parseErrors = [];

      lines.forEach((line, index) => {
        try {
          const json = JSON.parse(line);
          const id = json.news_item_id || json.id;

          if (!id) {
            parseErrors.push({ lineNumber: index + 1, message: '一意なIDが見つかりません (news_item_id / id)' });
            return;
          }

          dataById.set(id, { lineNumber: index + 1, data: json });
        } catch (error) {
          parseErrors.push({ lineNumber: index + 1, message: error.message });
        }
      });

      return {
        fileName: file.name,
        totalLines: lines.length,
        parsedCount: dataById.size,
        errors: parseErrors,
        dataById,
      };
    }

    function renderSummary(processedFiles) {
      summaryEl.innerHTML = '';

      processedFiles.forEach((file, index) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.style.borderLeft = `6px solid ${palette(index)}`;

        card.innerHTML = `
          <strong>${file.fileName}</strong>
          <span>有効なエントリ: ${file.parsedCount} / ${file.totalLines}</span>
          <span>エラー行: ${file.errors.length}</span>
        `;

        summaryEl.appendChild(card);
      });
    }

    function renderErrors(processedFiles) {
      const errorMessages = [];

      processedFiles.forEach((file) => {
        if (!file.errors.length) {
          return;
        }

        const lines = file.errors
          .slice(0, 20)
          .map((err) => `${file.fileName} | 行 ${err.lineNumber}: ${err.message}`);
        errorMessages.push(...lines);

        if (file.errors.length > 20) {
          errorMessages.push(`${file.fileName} | ... さらに ${file.errors.length - 20} 件`);
        }
      });

      if (!errorMessages.length) {
        errorsEl.hidden = true;
        errorsEl.textContent = '';
        return;
      }

      errorsEl.hidden = false;
      errorsEl.className = 'error-box';
      errorsEl.textContent = errorMessages.join('\n');
    }

    function renderArticles(processedFiles) {
      articlesEl.innerHTML = '';

      const allIds = new Set();
      processedFiles.forEach((file) => {
        file.dataById.forEach((_, id) => allIds.add(id));
      });

      if (!allIds.size) {
        articlesEl.innerHTML = '<p>比較対象となるIDが見つかりませんでした。</p>';
        return;
      }

      const sortedIds = Array.from(allIds).sort((a, b) => String(a).localeCompare(String(b)));

      sortedIds.forEach((id) => {
        const articleSection = document.createElement('article');
        articleSection.className = 'article';

        const firstAvailable = processedFiles.find((file) => file.dataById.has(id));
        const record = firstAvailable?.dataById.get(id)?.data ?? {};

        articleSection.appendChild(buildHeader(id, record));

        if (record.content) {
          const content = document.createElement('div');
          content.className = 'content';
          content.textContent = record.content;
          articleSection.appendChild(content);
        }

        const comparisonGrid = document.createElement('div');
        comparisonGrid.className = 'comparison-grid';

        processedFiles.forEach((file, index) => {
          const card = document.createElement('div');
          card.className = 'file-card';
          card.dataset.filename = file.fileName;
          card.style.setProperty('border-color', palette(index));
          card.style.setProperty('box-shadow', `inset 0 0 0 3px ${palette(index, 0.22)}`);

          const entry = file.dataById.get(id);

          if (!entry) {
            card.dataset.status = 'missing';
            card.innerHTML += '<p>該当記事なし</p>';
            comparisonGrid.appendChild(card);
            return;
          }

          const questionList = buildQuestionList(entry.data.questions);
          const choiceCount = Array.isArray(entry.data.questions)
            ? Math.max(...entry.data.questions.map((item) => Array.isArray(item.choices) ? item.choices.length : 0), 0)
            : 0;

          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = `問題数: ${questionList.childElementCount || 0}${choiceCount ? ` / 最大${choiceCount}択` : ''}`;
          card.appendChild(chip);

          if (questionList.childElementCount) {
            card.appendChild(questionList);
          } else {
            const noQuestion = document.createElement('p');
            noQuestion.textContent = '質問データがありません。';
            card.appendChild(noQuestion);
          }

          comparisonGrid.appendChild(card);
        });

        articleSection.appendChild(comparisonGrid);
        articlesEl.appendChild(articleSection);
      });
    }

    function buildHeader(id, record) {
      const header = document.createElement('header');

      const title = document.createElement('h2');
      title.textContent = record.headline ?? '（見出しなし）';
      header.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.appendChild(createMeta('ID', id));

      if (record.date_time) {
        meta.appendChild(createMeta('更新', record.date_time));
      }

      if (record.provider_id) {
        meta.appendChild(createMeta('提供', record.provider_id));
      }

      if (record.language) {
        meta.appendChild(createMeta('言語', record.language));
      }

      header.appendChild(meta);
      return header;
    }

    function buildQuestionList(questions) {
      const list = document.createElement('ul');
      list.className = 'question-list';

      if (!Array.isArray(questions)) {
        return list;
      }

      questions.forEach((item, index) => {
        const question = document.createElement('li');
        question.className = 'question-item';

        const title = document.createElement('div');
        title.textContent = `Q${index + 1}. ${item?.question ?? '（質問なし）'}`;
        question.appendChild(title);

        if (Array.isArray(item.choices) && item.choices.length) {
          const choices = document.createElement('ol');
          choices.className = 'choices';

          item.choices.forEach((choice, choiceIndex) => {
            const choiceItem = document.createElement('li');
            choiceItem.textContent = `${String.fromCharCode(65 + choiceIndex)}. ${choice}`;
            choices.appendChild(choiceItem);
          });

          question.appendChild(choices);
        }

        list.appendChild(question);
      });

      return list;
    }

    function createMeta(label, value) {
      const span = document.createElement('span');
      span.textContent = `${label}: ${value}`;
      return span;
    }

    function palette(index, alpha = 1) {
      const colors = [
        [37, 99, 235],
        [236, 72, 153],
        [16, 185, 129],
        [251, 146, 60],
      ];
      const [r, g, b] = colors[index % colors.length];
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function showNotice(message) {
      noticeEl.hidden = false;
      noticeEl.textContent = message;
    }

    function clearDisplay() {
      noticeEl.hidden = true;
      noticeEl.textContent = '';
      summaryEl.innerHTML = '';
      errorsEl.hidden = true;
      errorsEl.textContent = '';
      articlesEl.innerHTML = '';
    }
  </script>
</body>
</html>
