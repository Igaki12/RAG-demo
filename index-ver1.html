<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App æ™‚ä»£ã‚’æ‰ãˆã‚‹</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --text: #111827;
      --muted: #606b85;
      --edge: #cbd5e1;
      --glass-bg: rgb(255 255 255 / 62%);
      --glass-border: rgb(255 255 255 / 38%);
      --glass-shadow: 0 10px 28px rgba(17, 24, 39, .16);
      --accent-glow: #00aaff;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Meiryo, sans-serif
    }

    #network {
      position: fixed;
      inset: 0;
      width: 100dvw;
      height: 100dvh;
      background: var(--bg);
    }

    .overlay {
      position: fixed;
      z-index: 40;
      pointer-events: auto;
    }

    .hud-card {
      background: var(--glass-bg);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      backdrop-filter: blur(14px) saturate(160%);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      border-radius: 14px;
    }

    #hudTopLeft {
      top: 16px;
      left: 16px;
      padding: 12px 14px;
      display: grid;
      gap: 12px;
      max-width: min(92vw, 560px)
    }

    #hudTopLeft h1 {
      margin: 0;
      font-size: clamp(18px, 2.6vw, 22px);
      letter-spacing: .02em
    }

    .file-upload-area {
      text-align: center;
      padding: 20px;
    }

    .file-upload-area p {
      margin: 0 0 10px 0;
      color: var(--muted);
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      gap: .6em;
      font-weight: 600;
      padding: 10px 14px;
      border-radius: 10px;
      border: 2px dashed var(--edge);
      background: rgb(255 255 255 / 85%);
      cursor: pointer;
      width: max-content;
      transition: all 0.2s ease;
    }

    .file-label:hover {
      border-color: var(--accent-glow);
      color: var(--accent-glow);
    }

    .file-label input {
      display: none
    }

    #date-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-nav-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      transition: background .2s;
    }

    .date-nav-btn:hover:not(:disabled) {
      background: rgb(255 255 255 / 90%);
    }

    .date-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #current-date-display {
      font-size: 18px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      background: rgb(255 255 255 / 70%);
      border: 1px solid var(--glass-border);
      font-variant-numeric: tabular-nums;
    }

    #hudBottomLeft {
      left: 16px;
      bottom: 16px;
      padding: 12px 14px;
      width: min(92vw, 520px);
      display: none;
      /* Initially hidden */
    }

    #infoBox h2 {
      margin: 0 0 6px 0;
      font-size: 14px;
      color: var(--muted)
    }

    #details {
      margin: .25rem 0 0 1em;
      padding: 0;
      font-size: 14px;
      line-height: 1.55
    }

    /* === Modal === */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 80;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(17, 24, 39, .36);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .dialog {
      position: relative;
      z-index: 81;
      width: min(92vw, 720px);
      max-height: 86vh;
      background: var(--glass-bg);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      backdrop-filter: blur(18px) saturate(160%);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      border-radius: 16px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal.visible .dialog {
      transform: scale(1);
    }

    .dialog header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .dialog h2 {
      margin: 0;
      font-size: 18px;
    }

    .dialog .close {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }

    .dialog-content {
      overflow-y: auto;
      padding-right: 10px;
      /* for scrollbar */
    }

    #article-view h3 {
      margin-top: 0;
    }

    #article-view p {
      line-height: 1.7;
    }

    #article-actions {
      text-align: center;
      margin-top: 20px;
    }

    .btn-primary {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;

      background: rgba(255, 255, 255, 0.92);
      color: var(--text);
      border: 2px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(17, 24, 39, 0.08);
    }

    .btn-primary:hover {
      transform: translateY(-2px);

      background: #ffffff;
      border-color: var(--accent-glow);
      color: var(--accent-glow);
      box-shadow: 0 6px 18px rgba(0, 170, 255, 0.2);
    }

    #quiz-view {
      text-align: center;
    }

    .answer-box {
      background: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      line-height: 1.6;
      margin: 20px 0;
      font-size: 1.2em;
      font-weight: bold;
      animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
        font-size: 1em;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        font-size: 1.2em;
      }
        }

        #random-question-btn {
      background: rgba(255, 255, 255, 0.92);
      color: var(--text);
      border: 2px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(17, 24, 39, 0.08);
        }

        #random-question-btn:hover {
      background: #ffffff;
      border-color: var(--accent-glow);
      color: var(--accent-glow);
      box-shadow: 0 6px 18px rgba(0, 170, 255, 0.2);
    }

    .copyright-notice {
      position: fixed;
      right: 16px;
      bottom: 12px;
      font-size: 12px;
      color: var(--muted);
      opacity: 0.8;
    }

    #quiz-feedback button {
      font-size: 24px;
      padding: 10px 25px;
      border-radius: 10px;
      border: 2px solid var(--glass-border);
      cursor: pointer;
      margin: 0 10px;
      transition: transform 0.1s;
    }

    #quiz-feedback button:hover {
      transform: scale(1.1);
    }

    #good-btn {
      background-color: #d4edda;
    }

    #bad-btn {
      background-color: #f8d7da;
    }

    #quiz-result {
      text-align: center;
      padding: 40px 20px;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.8);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .result-animation {
      animation: fadeInScale 0.5s ease-out forwards;
    }

    #result-text {
      font-size: 24px;
      font-weight: bold;
    }

    #result-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    [hidden] {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- Fullscreen Network -->
  <div id="network" aria-label="å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"></div>

  <!-- å·¦ä¸Šï¼šã‚¿ã‚¤ãƒˆãƒ«ï¼‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ æ—¥ä»˜æ“ä½œ -->
  <div id="hudTopLeft" class="overlay hud-card" aria-live="polite">
    <h1>æ™‚ä»£ã‚’æ‰ãˆã‚‹</h1>
    <div id="upload-container" class="file-upload-area">
      <p>åˆ†æã—ãŸã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®JSONLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ãã®æ—¥ãã®æ™‚ä»£ã‚’é£¾ã£ãŸå‡ºæ¥äº‹ã«ã¤ã„ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
      <label class="file-label">
        <input id="file" type="file" accept=".jsonl" />
        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
      </label>
    </div>

    <div id="date-container" hidden>
      <p style="margin:0 0 8px 0; color:var(--muted); font-size:14px;">è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <div id="date-controls">
        <button id="prev-date-btn" class="date-nav-btn" title="å‰ã®æ—¥">â—€</button>
        <div id="current-date-display">YYYY-MM-DD</div>
        <button id="next-date-btn" class="date-nav-btn" title="æ¬¡ã®æ—¥">â–¶</button>
      </div>
      <button id="random-question-btn" class="btn-primary" style="display:none;">ãƒ©ãƒ³ãƒ€ãƒ ã§å•é¡Œã‚’å‡ºé¡Œã™ã‚‹</button>
    </div>
  </div>

  <!-- å·¦ä¸‹ï¼šãƒãƒ¼ãƒ‰è©³ç´° -->
  <div id="hudBottomLeft" class="overlay hud-card">
    <div id="infoBox">
      <h2>è©³ç´°</h2>
      <div id="info-placeholder" class="muted">æ°—ã«ãªã‚‹ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚Šã€å¼•ã£å¼µã£ãŸã‚Šã—ã¦ã¿ã¦ãã ã•ã„</div>
      <ul id="details"></ul>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¨˜äº‹è©³ç´° & ç†è§£åº¦ãƒ†ã‚¹ãƒˆ -->
  <div id="article-modal" class="modal">
    <div class="backdrop"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <header>
        <h2 id="modal-title">è¨˜äº‹è©³ç´°</h2>
        <button class="close" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      </header>
      <div class="dialog-content">
        <!-- Article View -->
        <div id="article-view">
          <h3 id="article-headline"></h3>
          <p id="article-content"></p>
          <div id="article-actions">
            <button id="read-another-btn" class="btn-primary" style="margin-right: 8px;">ä»–ã®è¨˜äº‹ã‚’èª­ã‚€</button>
            <button id="start-quiz-btn" class="btn-primary">ç†è§£åº¦ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
          </div>
        </div>
        <!-- Quiz View -->
        <div id="quiz-view" hidden>
          <p id="quiz-progress"></p>
          <p id="quiz-question"></p>
          <button id="show-answer-btn" class="btn-primary" style="margin: 20px 0;">è§£ç­”ã‚’ç¢ºèªã™ã‚‹</button>
          <div id="quiz-answer" class="answer-box" hidden></div>
          <div id="quiz-feedback" hidden>
            <p>è¨˜äº‹ã«ã¤ã„ã¦ç†è§£ã§ãã¾ã—ãŸã‹ï¼Ÿ</p>
            <button id="good-btn">ğŸ‘ ç†è§£ã§ããŸ</button>
            <button id="bad-btn">ğŸ‘ ç†è§£ã§ããªã‹ã£ãŸ</button>
          </div>
          <button id="toggle-article-btn" class="btn-primary" style="margin-top: 40px;" hidden>æ ¹æ‹ ã¨ãªã‚‹è¨˜äº‹ã‚’ç¢ºèªã™ã‚‹</button>
        </div>
        <!-- Result View -->
        <div id="quiz-result" hidden>
          <div id="result-icon"></div>
          <p id="result-text"></p>
        </div>
      </div>
    </div>
  </div>
  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ©ãƒ³ãƒ€ãƒ ç¢ºèªå•é¡Œ -->
  <div id="random-modal" class="modal">
    <div class="backdrop"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <header>
        <h2>ãƒ©ãƒ³ãƒ€ãƒ ã«ç¢ºèªå•é¡Œã‚’å‡ºé¡Œã™ã‚‹</h2>
        <button class="close" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      </header>
      <div class="dialog-content" id="random-content">
        <p id="random-question-text"></p>
        <div id="random-answer" class="answer-box" hidden></div>
        <div style="text-align:center; margin-top:24px;">
          <button id="random-show-answer-btn" class="btn-primary" style="margin:20px 0;">è§£ç­”ã‚’ç¢ºèªã™ã‚‹</button>
          <button id="random-open-article-btn" class="btn-primary">ã©ã‚“ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãªã®ã‹ç¢ºèªã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="copyright-notice overlay">
    2025 Â© Happyman All rights reserved.
  </div>

  <script type="module">
    import { DataSet, Network } from 'https://unpkg.com/vis-network/standalone/esm/vis-network.min.js';

    // ====== DOM Elements ======
    const $ = (id) => document.getElementById(id);
    const fileInput = $('file');
    const uploadContainer = $('upload-container');
    const dateContainer = $('date-container');
    const randomQuestionBtn = $('random-question-btn');
    const prevDateBtn = $('prev-date-btn');
    const nextDateBtn = $('next-date-btn');
    const currentDateDisplay = $('current-date-display');
    const networkContainer = $('network');
    const hudBottomLeft = $('hudBottomLeft');
    const infoPlaceholder = $('info-placeholder');
    const detailsList = $('details');
    // Modal elements
    const articleModal = $('article-modal');
    const modalTitle = $('modal-title');
    const articleView = $('article-view');
    const articleHeadline = $('article-headline');
    const articleContent = $('article-content');
    const articleActions = $('article-actions');
    const startQuizBtn = $('start-quiz-btn');
    const quizView = $('quiz-view');
    const quizProgress = $('quiz-progress');
    const quizQuestion = $('quiz-question');
    const showAnswerBtn = $('show-answer-btn');
    const quizAnswer = $('quiz-answer');
    const quizFeedback = $('quiz-feedback');
    const goodBtn = $('good-btn');
    const badBtn = $('bad-btn');
    const quizResult = $('quiz-result');
    const resultIcon = $('result-icon');
    const resultText = $('result-text');
    // è¿½åŠ 
    const readAnotherBtn = $('read-another-btn');
    const toggleArticleBtn = $('toggle-article-btn');
    const randomModal = $('random-modal');
    const randomQuestionText = $('random-question-text');
    const randomAnswer = $('random-answer');
    const randomShowAnswerBtn = $('random-show-answer-btn');
    const randomOpenArticleBtn = $('random-open-article-btn');

    // ====== State ======
    let network;
    let allArticles = [];
    let articlesByDate = new Map();
    let availableDates = [];
    let currentDateIndex = -1;
    let completedNodes = new Set();
    let glowAnimationId = null;
    let currentQuiz = {
      nodeId: null,
      article: null,
      questions: [],
      qIndex: 0,
      good: 0,
      bad: 0
    };
    let isArticleVisibleInQuiz = false;
    const randomState = { article: null, question: null };

    // ====== Helpers ======
    const fmt = (n) => n.toLocaleString('ja-JP');
    const logValue = (c) => (!c || c <= 1) ? 2 : Math.log(c) * 5 + 2;
    const keyPair = (a, b) => a < b ? `${a}|||${b}` : `${b}|||${a}`;

    const PALETTE = [
      '#f8e8e8', '#fde4ec', '#ffe8e0', '#fff4da', '#f5f2d8', '#eaf7d5', '#dbf1e4', '#e5f6f9',
      '#e6f0ff', '#ece5ff', '#efe6f5', '#f7e8ef', '#f0f7ff', '#e8fff4', '#fff0f0', '#f4f9e8'
    ];
    function hash(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) { h = Math.imul(31, h) + str.charCodeAt(i) | 0; }
      return h;
    }
    function colorForSubject(code) {
      if (!code) return '#f0f0f0';
      const idx = Math.abs(hash(code)) % PALETTE.length;
      return PALETTE[idx];
    }
    function borderFor(bg) {
      const r = parseInt(bg.slice(1, 3), 16), g = parseInt(bg.slice(3, 5), 16), b = parseInt(bg.slice(5, 7), 16);
      const f = 0.82;
      const rr = Math.floor(r * f).toString(16).padStart(2, '0');
      const gg = Math.floor(g * f).toString(16).padStart(2, '0');
      const bb = Math.floor(b * f).toString(16).padStart(2, '0');
      return `#${rr}${gg}${bb}`;
    }

    // ====== File Processing ======
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const text = await file.text();
      const lines = text.split(/\r?\n/);

      allArticles = [];
      articlesByDate.clear();

      for (const line of lines) {
        if (!line.trim()) continue;
        try {
          const obj = JSON.parse(line);
          if (obj.date_id && obj.named_entities && obj.content) {
            allArticles.push(obj);
            const dateStr = obj.date_id.toString();
            if (!articlesByDate.has(dateStr)) {
              articlesByDate.set(dateStr, []);
            }
            articlesByDate.get(dateStr).push(obj);
          }
        } catch (err) {
          console.warn('JSON parse error:', err);
        }
      }

      if (articlesByDate.size > 0) {
        availableDates = Array.from(articlesByDate.keys()).sort();
        currentDateIndex = availableDates.length - 1;
        uploadContainer.hidden = true;
        dateContainer.hidden = false;
        randomQuestionBtn.style.display = 'block';
        hudBottomLeft.style.display = 'block';
        updateDisplayForDateChange();
        startGlowAnimation();
      } else {
        alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹JSONLãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚date_id, named_entities, contentãŒå¿…è¦ã§ã™ã€‚');
      }
    });

    // ====== Date Navigation ======
    function updateDisplayForDateChange() {
      if (currentDateIndex < 0 || currentDateIndex >= availableDates.length) return;

      const currentDate = availableDates[currentDateIndex];
      const formattedDate = `${currentDate.slice(0, 4)}-${currentDate.slice(4, 6)}-${currentDate.slice(6, 8)}`;
      currentDateDisplay.textContent = formattedDate;

      prevDateBtn.disabled = currentDateIndex === 0;
      nextDateBtn.disabled = currentDateIndex === availableDates.length - 1;

      renderGraphForDate(currentDate);
    }

    prevDateBtn.addEventListener('click', () => {
      if (currentDateIndex > 0) {
        currentDateIndex--;
        updateDisplayForDateChange();
      }
    });
    nextDateBtn.addEventListener('click', () => {
      if (currentDateIndex < availableDates.length - 1) {
        currentDateIndex++;
        updateDisplayForDateChange();
      }
    });

    // ====== Graph Rendering & Animation ======
    function glowAnimation() {
      const time = new Date().getTime() / 400;
      const amplitude = 15;
      const baseSize = 30;
      const pulse = baseSize + amplitude * Math.sin(time);

      const updates = [];
      for (const nodeId of completedNodes) {
        if (network && network.body.data.nodes.get(nodeId)) {
          updates.push({
            id: nodeId,
            shadow: { enabled: true, color: '#FFD700', size: pulse, x: 0, y: 0 },
            color: { border: '#FFD700' },
            font: { bold: { mod: 'normal' } }
          });

        }
      }

      if (updates.length > 0) {
        network.body.data.nodes.update(updates);
      }
      glowAnimationId = requestAnimationFrame(glowAnimation);
    }

    function startGlowAnimation() {
      if (glowAnimationId) {
        cancelAnimationFrame(glowAnimationId);
      }
      glowAnimation();
    }

    function renderGraphForDate(dateStr) {
      const articles = articlesByDate.get(dateStr) || [];
      if (articles.length === 0) {
        if (network) network.setData({ nodes: [], edges: [] });
        return;
      }

      const entityCount = new Map();
      const entitySubjectCounts = new Map();

      articles.forEach(article => {
        const entities = [...new Set(article.named_entities)].filter(e => e.length > 1);
        entities.forEach(entity => {
          entityCount.set(entity, (entityCount.get(entity) || 0) + 1);

          if (!entitySubjectCounts.has(entity)) entitySubjectCounts.set(entity, new Map());
          const subjectMap = entitySubjectCounts.get(entity);
          if (article.subject_codes) {
            article.subject_codes.forEach(sc => {
              const code = sc.subject_matter;
              if (code) subjectMap.set(code, (subjectMap.get(code) || 0) + 1);
            });
          }
        });
      });

      const topEntities = Array.from(entityCount.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 50)
        .map(d => d[0]);

      const nodes = topEntities.map(entity => {
        let dominantSubject = null;
        let maxCount = 0;
        const subjectMap = entitySubjectCounts.get(entity);
        if (subjectMap) {
          for (const [subject, count] of subjectMap.entries()) {
            if (count > maxCount) {
              maxCount = count;
              dominantSubject = subject;
            }
          }
        }
        const bgColor = colorForSubject(dominantSubject);
        const isCompleted = completedNodes.has(entity);

        return {
          id: entity,
          label: `<b>${entity}</b>`,
          value: logValue(entityCount.get(entity)),
          title: `å‡ºç¾å›æ•°: ${entityCount.get(entity)}`,
          color: { background: bgColor, border: borderFor(bgColor) },
          shadow: isCompleted ? { enabled: true, color: '#FFD700', size: 30, x: 0, y: 0 } : { enabled: false },
        };
      });

      const edgeCounts = new Map();
      const topSet = new Set(topEntities);
      articles.forEach(article => {
        const entitiesInArticle = [...new Set(article.named_entities)].filter(e => topSet.has(e));
        for (let i = 0; i < entitiesInArticle.length; i++) {
          for (let j = i + 1; j < entitiesInArticle.length; j++) {
            const key = keyPair(entitiesInArticle[i], entitiesInArticle[j]);
            edgeCounts.set(key, (edgeCounts.get(key) || 0) + 1);
          }
        }
      });

      const edges = Array.from(edgeCounts.entries())
        .filter(([, count]) => count > 1) // å…±èµ·å›æ•°2å›ä»¥ä¸Šã®ã‚¨ãƒƒã‚¸ã®ã¿
        .map(([key, count]) => {
          const [from, to] = key.split('|||');
          return { from, to, value: count, title: `å…±èµ·å›æ•°: ${count}` };
        });

      const data = { nodes: new DataSet(nodes), edges: new DataSet(edges) };
      const options = {
        interaction: { hover: true },
        physics: { stabilization: { iterations: 150 }, barnesHut: { gravitationalConstant: -4000 } },
        nodes: {
          shape: 'dot',
          font: { multi: 'html', size: 18, strokeWidth: 3, strokeColor: 'white' },
          scaling: { min: 15, max: 60 },
          borderWidth: 2,
        },
        edges: { color: { color: '#cccccc', highlight: '#b0b0b0' }, smooth: { type: 'continuous' } }
      };

      if (!network) {
        network = new Network(networkContainer, data, options);
        network.on('click', handleNodeClick);
      } else {
        network.setData(data);
      }
    }

    function handleNodeClick(params) {
      detailsList.innerHTML = '';
      if (params.nodes.length > 0) {
        infoPlaceholder.hidden = true;
        const nodeId = params.nodes[0];
        const nodeData = network.body.data.nodes.get(nodeId);
        detailsList.innerHTML = `<li><b>${nodeId}</b>: ${nodeData.title}</li>`;

        const relatedArticles = allArticles.filter(a =>
          a.named_entities.includes(nodeId) && a.content && a.content.length > 50
        );

        if (relatedArticles.length > 0) {
          // æœ¬æ–‡ã®é•·ã„è¨˜äº‹ã‚’å„ªå…ˆï¼šé•·ã•ã§é™é †ã‚½ãƒ¼ãƒˆã—ã€ä¸Šä½5ä»¶ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
          const sortedByLength = relatedArticles
            .slice()
            .sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
          const topK = Math.min(5, sortedByLength.length);
          const candidates = sortedByLength.slice(0, topK);
          const chosen = candidates[Math.floor(Math.random() * candidates.length)];

          openArticleModal(nodeId, chosen);
        } else {
          detailsList.innerHTML += `<li>è©³ç´°ãªé–¢é€£è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>`;
        }

      } else {
        infoPlaceholder.hidden = false;
      }
    }

    // ====== Modal & Quiz Logic ======
    function openArticleModal(nodeId, article) {
      currentQuiz.nodeId = nodeId;
      currentQuiz.article = article;
      modalTitle.textContent = `é–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹: ${nodeId}`;
      articleHeadline.textContent = article.headline || 'è¦‹å‡ºã—ãªã—';
      articleContent.textContent = article.content;

      articleView.hidden = false;
      quizView.hidden = true;
      quizResult.hidden = true;
      articleActions.hidden = false;
      toggleArticleBtn.hidden = true;
      isArticleVisibleInQuiz = false;
      toggleArticleBtn.textContent = 'æ ¹æ‹ ã¨ãªã‚‹è¨˜äº‹ç¢ºèªã™ã‚‹';

      articleModal.classList.add('visible');
    }

    function closeModal() {
      articleModal.classList.remove('visible');
      isArticleVisibleInQuiz = false;
      toggleArticleBtn.hidden = true;
      articleActions.hidden = false;
      articleView.hidden = false;
    }

    function updateArticleVisibilityDuringQuiz(shouldShow) {
      isArticleVisibleInQuiz = shouldShow;
      articleView.hidden = !shouldShow;
      toggleArticleBtn.textContent = shouldShow ? 'è¨˜äº‹ã‚’éš ã™' : 'è¨˜äº‹ã‚’ç¢ºèªã™ã‚‹';
    }

    articleModal.querySelector('.backdrop').addEventListener('click', closeModal);
    articleModal.querySelector('.close').addEventListener('click', closeModal);

    randomModal.querySelector('.backdrop').addEventListener('click', closeRandomModal);
    randomModal.querySelector('.close').addEventListener('click', closeRandomModal);

    // è¿½åŠ : ä»–ã®è¨˜äº‹ã‚’èª­ã‚€
    readAnotherBtn.addEventListener('click', () => {
      if (!currentQuiz.nodeId || !currentQuiz.article) return;

      const nodeId = currentQuiz.nodeId;
      const excludeId = currentQuiz.article.news_item_id;

      const relatedArticles = allArticles.filter(a =>
        a.named_entities.includes(nodeId) &&
        a.content && a.content.length > 50 &&
        a.news_item_id !== excludeId
      );

      if (relatedArticles.length === 0) {
        alert('ä»–ã®è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      // æœ¬æ–‡ã®é•·ã„è¨˜äº‹ã‚’å„ªå…ˆï¼šé™é †â†’ä¸Šä½5ä»¶ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 
      const sortedByLength = relatedArticles
        .slice()
        .sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
      const topK = Math.min(5, sortedByLength.length);
      const candidates = sortedByLength.slice(0, topK);
      const chosen = candidates[Math.floor(Math.random() * candidates.length)];

      // Article Viewã‚’ä¸€æ—¦é–‰ã˜ã¦ã‹ã‚‰å·®ã—æ›¿ãˆ
      articleView.hidden = true;
      quizView.hidden = true;
      quizResult.hidden = true;

      openArticleModal(nodeId, chosen);
    });

    startQuizBtn.addEventListener('click', () => {
      const questions = currentQuiz.article.questions;
      if (!questions || questions.length === 0) {
        finishQuiz(true);
        return;
      }
      currentQuiz.questions = questions;
      currentQuiz.qIndex = 0;
      currentQuiz.good = 0;
      currentQuiz.bad = 0;
      quizResult.hidden = true;
      quizView.hidden = false;
      articleActions.hidden = true;
      toggleArticleBtn.hidden = false;
      updateArticleVisibilityDuringQuiz(false);
      showNextQuestion();
    });

    toggleArticleBtn.addEventListener('click', () => {
      const nextState = !isArticleVisibleInQuiz;
      updateArticleVisibilityDuringQuiz(nextState);
      articleActions.hidden = true;
    });

    showAnswerBtn.addEventListener('click', () => {
      showAnswerBtn.hidden = true;
      quizAnswer.hidden = false;
      quizFeedback.hidden = false;
    });

    function showNextQuestion() {
      if (currentQuiz.qIndex >= currentQuiz.questions.length) {
        finishQuiz();
        return;
      }

      showAnswerBtn.hidden = false;
      quizAnswer.hidden = true;
      quizFeedback.hidden = true;
      updateArticleVisibilityDuringQuiz(false);

      const q = currentQuiz.questions[currentQuiz.qIndex];
      quizProgress.textContent = `å•é¡Œ ${currentQuiz.qIndex + 1} / ${currentQuiz.questions.length}`;
      quizQuestion.textContent = q.question;
      quizAnswer.textContent = q.answer;
    }

    goodBtn.addEventListener('click', () => {
      currentQuiz.good++;
      currentQuiz.qIndex++;
      showNextQuestion();
    });

    badBtn.addEventListener('click', () => {
      currentQuiz.bad++;
      currentQuiz.qIndex++;
      showNextQuestion();
    });

    function finishQuiz(forceSuccess = false) {
      const isSuccess = forceSuccess || currentQuiz.good >= currentQuiz.bad;
      if (isSuccess) {
        completedNodes.add(currentQuiz.nodeId);
        showQuizResult(true);
      } else {
        const relatedArticles = allArticles.filter(a =>
          a.named_entities.includes(currentQuiz.nodeId) &&
          a.news_item_id !== currentQuiz.article.news_item_id &&
          a.content.length > 50
        );
        if (relatedArticles.length > 0) {
          const newArticle = relatedArticles[Math.floor(Math.random() * relatedArticles.length)];
          showQuizResult(false, () => openArticleModal(currentQuiz.nodeId, newArticle));
        } else {
          showQuizResult(false, () => {
            alert('åˆ¥ã®é–¢é€£è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            closeModal();
          });
        }
      }
    }

    function showQuizResult(isSuccess, callback) {
      updateArticleVisibilityDuringQuiz(false);
      toggleArticleBtn.hidden = true;
      articleActions.hidden = false;
      quizView.hidden = true;
      quizResult.hidden = false;
      quizResult.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'result-animation';

      if (isSuccess) {
        container.innerHTML = `
                <div id="result-icon">ğŸ‰</div>
                <p id="result-text">ç´ æ™´ã‚‰ã—ã„ï¼ä»–ã®ãƒ†ãƒ¼ãƒã«ã‚‚æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†</p>
            `;
        quizResult.appendChild(container);
        setTimeout(() => {
          closeModal();
          if (callback) callback();
        }, 2000);
      } else {
        container.innerHTML = `
                <div id="result-icon">ğŸ¤”</div>
                <p id="result-text">ã‚‚ã†å°‘ã—ã§ã™ï¼åˆ¥ã®è¨˜äº‹ã§å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚</p>
            `;
        quizResult.appendChild(container);
        setTimeout(() => {
          if (callback) callback();
          else closeModal();
        }, 2500);
      }
    }

    randomQuestionBtn.addEventListener('click', handleRandomQuestion);
    randomShowAnswerBtn.addEventListener('click', () => {
      randomShowAnswerBtn.hidden = true;
      randomAnswer.hidden = false;
    });
    randomOpenArticleBtn.addEventListener('click', () => {
      closeRandomModal();
      if (randomState.article) {
        const defaultNodeId =
          (Array.isArray(randomState.article.named_entities) && randomState.article.named_entities[0]) ||
          (randomState.article.headline ?? 'ãƒ©ãƒ³ãƒ€ãƒ è¨˜äº‹');
        openArticleModal(defaultNodeId, randomState.article);
      }
    });

    function handleRandomQuestion() {
      if (currentDateIndex < 0 || currentDateIndex >= availableDates.length) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const dateStr = availableDates[currentDateIndex];
      const candidates = (articlesByDate.get(dateStr) || []).filter(a => Array.isArray(a.questions) && a.questions.length > 0);
      if (candidates.length === 0) {
        alert('ã“ã®æ—¥ä»˜ã«ã¯å‡ºé¡Œã§ãã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      const article = candidates[Math.floor(Math.random() * candidates.length)];
      const question = article.questions[Math.floor(Math.random() * article.questions.length)];
      randomState.article = article;
      randomState.question = question;
      randomQuestionText.textContent = question.question || 'å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      randomAnswer.textContent = question.answer || 'è§£ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      randomShowAnswerBtn.hidden = false;
      randomAnswer.hidden = true;
      openRandomModal();
    }

    function openRandomModal() {
      randomModal.classList.add('visible');
    }

    function closeRandomModal() {
      randomModal.classList.remove('visible');
    }

  </script>
</body>

</html>